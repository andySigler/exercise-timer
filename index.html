<!DOCTYPE html>
<html>
    <head>
        <style type="text/css">
            body, p, h1, h2, select {
                font-family: Helvetica;
            }
            h1 {
                font-size: 300px;
                width:100%;
                margin-top:0px;
            }
            h2 {
                font-size: 40px;
                width:100%;
            }
            .container {
                width: 100%;
                max-width: 600px;
                margin-top:80px;
                margin-right: auto;
                margin-left: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <select id="exerciseSelect">
                <option value="warm_up">Warm-Up</option>
                <option value="full_body">Full-Body</option>
                <option value="back">Back</option>
                <option value="random">Random Excercise</option>
            </select>
            <span id="description"></span>
            <br>
            <input type="checkbox" id="homeCheckbox" checked> Home
            <h2 id="exerciseName"></h2>
            <h1 id="exerciseSeconds"></h1>
        </div>
    </body>
    <script type="text/javascript">

        var _ex_warm_up = [
            {
                "name": "Bar Hang",
                "seconds": 60,
                "sets": 1,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Corner Stretch",
                "seconds": 30,
                "sets": 2,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Wall Lats Stretch",
                "seconds": 30,
                "sets": 2,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bar Hang",
                "seconds": 60,
                "sets": 1,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Bird Dog",
                "seconds": 120,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bar Hang",
                "seconds": 60,
                "sets": 1,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Cat Camel",
                "seconds": 120,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bar Hang",
                "seconds": 60,
                "sets": 1,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "T-Spine Rotation",
                "seconds": 120,
                "sets": 2,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bar Hang",
                "seconds": 60,
                "sets": 1,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Hamstring Stretch",
                "seconds": 30,
                "sets": 4,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bar Hang",
                "seconds": 60,
                "sets": 1,
                "extraWait": 10,
                "home": true
            }
        ];

        var _ex_full_body = [
            {
                "name": "Standing Bird Dog",
                "seconds": 120,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Squats",
                "seconds": 30,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Ball Crunches",
                "seconds": 30,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Push-Up Rotate",
                "seconds": 30,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Plank",
                "seconds": 60,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Straight Leg Raise",
                "seconds": 30,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Raise Knee Hip",
                "seconds": 30,
                "sets": 2,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bicycles",
                "seconds": 30,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Lunges",
                "seconds": 30,
                "sets": 1,
                "extraWait": 0,
                "home": false
            },
            // stretch
            {
                "name": "Lunge Hip Flex",
                "seconds": 30,
                "sets": 2,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Elbow Lunge",
                "seconds": 30,
                "sets": 2,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "90:90 Hips",
                "seconds": 30,
                "sets": 2,
                "extraWait": 0,
                "home": false
            }
        ];

        var _ex_back = [
            {
                "name": "Pull Ups",
                "seconds": 45,
                "sets": 1,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Standing Band Twist",
                "seconds": 45,
                "sets": 2,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Rope Pull",
                "seconds": 45,
                "sets": 1,
                "extraWait": 0,
                "home": true
            },
            {
                "name": "Band Pull-Down",
                "seconds": 90,
                "sets": 1,
                "extraWait": 0,
                "home": true
            },
            {
                "name": "Standing Band Raise",
                "seconds": 45,
                "sets": 2,
                "extraWait": 0,
                "home": true
            },
            {
                "name": "WTYL",
                "seconds": 45,
                "sets": 4,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Walking Superman",
                "seconds": 45,
                "sets": 2,
                "extraWait": 0,
                "home": false
            }
        ];

        var exercises = {
            'warm_up': _ex_warm_up,
            'full_body': _ex_full_body,
            'back': _ex_back
        };
        var schedule = [
            'back',           // Sunday
            'full_body',      // Monday
            'back',           // Tuesday
            'full_body',      // Wednesday
            'back',           // Thursday
            'full_body',      // Friday
            'warm_up',        // Saturday
        ];
        var fullExer = [];
        var interval = undefined;

        var restTime = 20;
        var currentSecond = 0;
        var currentStep = 0;
        var totalSecondCounter = 0;
        var totMinutes = 0;

        var isRunning = false;

        var shuffle = function (array) {
            var currentIndex = array.length;
            var temporaryValue, randomIndex;
            while (0 !== currentIndex) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }
            return array;
        };

        var removeHome = function (exerciseArray) {
            var newExer = [];
            exerciseArray.map((ex) => {
                if (!ex.home) {
                    newExer.push(ex);
                }
            });
            return newExer.slice();
        }

        var expandSets = function (exerciseArray) {
            var newExer = [];
            exerciseArray.map((ex) => {
                if (ex.sets && ex.sets > 1) {
                    for (var i=0;i<ex.sets;i++){
                        newExer.push(Object.assign({}, ex));
                    }
                } else {
                    newExer.push(ex);
                }
            });
            return newExer.slice();
        }

        function preloadExercise(name, atHome) {
            /*
            {
                "exercise": [
                    {
                        "name": "name",
                        "seconds": 123,
                        "sets": 1,
                        "extraWait": 10,
                        "home": false
                    }
                ]
            }
            */
            fullExer = [];
            if (name == 'random') {
                // all exercises included in random
                fullExer = fullExer.concat(exercises['full_body']);
                fullExer = fullExer.concat(exercises['back']);
                fullExer = shuffle(fullExer);
            } else {
                fullExer = exercises[name];
            }
            // prepend with warmp up
            if (name != 'warm_up') {
                fullExer = exercises['warm_up'].concat(fullExer);
            }
            fullExer = expandSets(fullExer);
            if (atHome == false) {
                fullExer = removeHome(fullExer);
            }
            calculateTimeRemaining();
            displayNameTime();
        }

        function calculateTimeRemaining() {
            var totalSteps = 0;
            totMinutes = fullExer.reduce((tot, val, i) => {
                if (currentStep <= i) {
                    totalSteps += 1;
                    tot += (val.seconds / 60);
                    if (val.extraWait) {
                        tot += (val.extraWait / 60)
                    }
                }
                return tot
            }, 0);
            totMinutes += (restTime * totalSteps) / 60;
            totalSecondCounter = Math.round(totMinutes * 60);
        }

        function getTimeRemainingString() {
            var min = Math.floor(totalSecondCounter / 60);
            min = String(min);
            if (min < 10) min = '0' + min;
            var sec = totalSecondCounter % 60;
            sec = String(sec);
            if (sec < 10) sec = '0' + sec;
            return min + ':' + sec;
        }

        function displayNameTime() {
            var exName = fullExer[currentStep].name;
            // exName += '<br>' + String(currentStep + 1) + ' / ' + String(fullExer.length);
            exName += '<br>' + getTimeRemainingString();
            document.getElementById('exerciseName').innerHTML = exName;
            var secondsDisplay = Math.floor(currentSecond);
            if (secondsDisplay >= 0) {
                secondsDisplay = fullExer[currentStep].seconds - secondsDisplay;
            }
            secondsDisplay = String(Math.abs(secondsDisplay));
            document.getElementById('exerciseSeconds').innerHTML = secondsDisplay;
        }

        function setColor(color) {
            document.body.style.backgroundColor = color;
        }

        function clearNameTime() {
            document.getElementById('exerciseName').innerHTML = 'Off';
            document.getElementById('exerciseSeconds').innerHTML = '...';
        }

        function shiftToNeighborExercise(direction) {
            currentStep += direction;
            if (currentStep < 0) currentStep = 0;
            if (currentStep >= fullExer.length) {
                currentStep = fullExer.length;
                stop();
                return;
            }
            currentSecond = restTime * -1;
            if (fullExer[currentStep].extraWait) {
                currentSecond -= fullExer[currentStep].extraWait
            }
        }

        function workoutStep() {
            totalSecondCounter -= 1;
            currentSecond += 1;
            if (currentSecond >= fullExer[currentStep].seconds) {
                shiftToNeighborExercise(1);
            }
            if (currentSecond < 0) {
                displayNameTime();
                setColor('white');
            }
            else if (currentSecond < fullExer[currentStep].seconds){
                displayNameTime();
                setColor('rgb(0, 255, 123)');
            }
        }

        function onResumePauseButtonPress() {
            if (isRunning === false) {
                isRunning = true;
                start();
            }
            else {
                isRunning = false;
                pause();
            }
        }

        function pause() {
            if (interval !== undefined) {
                clearInterval(interval);
                interval = undefined;
                setColor('white');
            }
        }

        function start() {
            if (!interval) {
                interval = setInterval(workoutStep, 1000);
                workoutStep();
            }
        }

        function stop() {
            pause();
            clearNameTime();
            currentStep = 0;
            currentSecond = restTime * -1;
            setColor('grey');
        }

        function skip(direction) {
            shiftToNeighborExercise(direction);
            calculateTimeRemaining();
            displayNameTime();
        }

        document.addEventListener('keydown', (event) => {
            if(event.keyCode === 32) { // space
                onResumePauseButtonPress();
                event.preventDefault();
            }
            else if(event.keyCode === 39) { // arrow right
                skip(1);
                event.preventDefault();
            } else if(event.keyCode === 37) { // arrow left
                skip(-1);
                event.preventDefault();
            }
        }, false);

        var setFromUi = function(e) {
            console.log('here')
            atHome = document.getElementById('homeCheckbox').checked;
            exSel = document.getElementById('exerciseSelect').value;
            preloadExercise(exSel, atHome);
        }

        document.getElementById('exerciseSelect').addEventListener('change', setFromUi);
        document.getElementById('homeCheckbox').addEventListener('click', setFromUi);

        window.addEventListener('load', (event) => {
            stop();
            name = schedule[new Date().getDay()];
            document.getElementById('exerciseSelect').value = name;
            preloadExercise(name);
        });

    </script>
</html>
