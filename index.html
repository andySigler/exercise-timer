<!DOCTYPE html>
<html>
    <head>
        <style type="text/css">
            body, p, h1, h2, select {
                font-family: Helvetica;
            }
            h1 {
                font-size: 300px;
                width:100%;
                margin-top:0px;
            }
            h2 {
                font-size: 40px;
                width:100%;
            }
            .container {
                width: 100%;
                max-width: 600px;
                margin-top:80px;
                margin-right: auto;
                margin-left: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <select id="exerciseSelect">
                <option value="simple">Simple</option>
                <option value="random">Random</option>
            </select>
            <span id="description"></span>
            <br>
            <input type="checkbox" id="homeCheckbox" checked> Home
            <h2 id="exerciseName"></h2>
            <h1 id="exerciseSeconds"></h1>
        </div>
    </body>
    <script type="text/javascript">

        var exercises = {};
        var fullExer = [];
        var interval = undefined;

        var restTime = 20;
        var currentSecond = 0;
        var currentStep = 0;
        var totalSecondCounter = 0;
        var totMinutes = 0;

        var atHome = true;
        var isRunning = false;

        var shuffle = function (array) {
            var currentIndex = array.length;
            var temporaryValue, randomIndex;
            while (0 !== currentIndex) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex -= 1;
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }
            return array;
        };

        var removeHome = function (exerciseArray) {
            var newExer = [];
            exerciseArray.map((ex) => {
                if (!ex.home) {
                    newExer.push(ex);
                }
            });
            return newExer.slice();
        }

        function preloadExercise(name) {
            /*
            {
                "exercise": [
                    {
                        "name": "name",
                        "seconds": 123,
                        "extraWait": 10,
                        "home": false
                    }
                ]
            }
            */
            // TODO: load exercises from CSV file
            fullExer = exercises[name].slice();
            if (document.getElementById('randomCheckbox').checked) {
                fullExer = shuffle(fullExer);
            }
            if (atHome == false) {
                fullExer = removeHome(fullExer);
            }
            calculateTimeRemaining();
            displayNameTime();
        }

        function calculateTimeRemaining() {
            var totalSteps = 0;
            totMinutes = fullExer.reduce((tot, val, i) => {
                if (currentStep <= i) {
                    totalSteps += 1;
                    tot += (val.seconds / 60);
                    if (val.extraWait) {
                        tot += (val.extraWait / 60)
                    }
                }
                return tot
            }, 0);
            totMinutes += (restTime * totalSteps) / 60;
            totalSecondCounter = Math.round(totMinutes * 60);
        }

        function getTimeRemainingString() {
            var min = Math.floor(totalSecondCounter / 60);
            min = String(min);
            if (min < 10) min = '0' + min;
            var sec = totalSecondCounter % 60;
            sec = String(sec);
            if (sec < 10) sec = '0' + sec;
            return min + ':' + sec;
        }

        function displayNameTime() {
            var exName = fullExer[currentStep].name;
            // exName += '<br>' + String(currentStep + 1) + ' / ' + String(fullExer.length);
            exName += '<br>' + getTimeRemainingString();
            document.getElementById('exerciseName').innerHTML = exName;
            var secondsDisplay = Math.floor(currentSecond);
            if (secondsDisplay >= 0) {
                secondsDisplay = fullExer[currentStep].seconds - secondsDisplay;
            }
            secondsDisplay = String(Math.abs(secondsDisplay));
            document.getElementById('exerciseSeconds').innerHTML = secondsDisplay;
        }

        function setColor(color) {
            document.body.style.backgroundColor = color;
        }

        function clearNameTime() {
            document.getElementById('exerciseName').innerHTML = 'Off';
            document.getElementById('exerciseSeconds').innerHTML = '...';
        }

        function shiftToNeighborExercise(direction) {
            currentStep += direction;
            if (currentStep < 0) currentStep = 0;
            if (currentStep >= fullExer.length) {
                currentStep = fullExer.length;
                stop();
                return;
            }
            currentSecond = restTime * -1;
            if (fullExer[currentStep].extraWait) {
                currentSecond -= fullExer[currentStep].extraWait
            }
        }

        function workoutStep() {
            totalSecondCounter -= 1;
            currentSecond += 1;
            if (currentSecond >= fullExer[currentStep].seconds) {
                shiftToNeighborExercise(1);
            }
            if (currentSecond < 0) {
                displayNameTime();
                setColor('white');
            }
            else if (currentSecond < fullExer[currentStep].seconds){
                displayNameTime();
                setColor('rgb(0, 255, 123)');
            }
        }

        function onResumePauseButtonPress() {
            if (isRunning === false) {
                isRunning = true;
                start();
            }
            else {
                isRunning = false;
                pause();
            }
        }

        function pause() {
            if (interval !== undefined) {
                clearInterval(interval);
                interval = undefined;
                setColor('white');
            }
        }

        function start() {
            if (!interval) {
                interval = setInterval(workoutStep, 1000);
                workoutStep();
            }
        }

        function stop() {
            pause();
            clearNameTime();
            currentStep = 0;
            currentSecond = restTime * -1;
            setColor('grey');
        }

        function skip(direction) {
            shiftToNeighborExercise(direction);
            calculateTimeRemaining();
            displayNameTime();
        }

        document.addEventListener('keydown', (event) => {
            if(event.keyCode === 32) { // space
                onResumePauseButtonPress();
            }
            else if(event.keyCode === 39) { // arrow right
                skip(1);
            } else if(event.keyCode === 37) { // arrow left
                skip(-1);
            }
            event.preventDefault();
        }, false);

        window.addEventListener('load', (event) => {
            stop();
            preloadExercise('simple'); // assume simple mode
        });

        document.getElementById('exerciseSelect').addEventListener('change', (e) => {
            // TODO: get the name of the selected exercise
            preloadExercise('simple');
        });

        document.getElementById('homeCheckbox').addEventListener('click', (event) => {
            atHome = document.getElementById('homeCheckbox').checked;
            // TODO: get the name of the selected exercise
            preloadExercise('simple');
        });

    </script>
</html>
