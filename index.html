<!DOCTYPE html>
<html>
    <head>
        <style type="text/css">
            body, p, h1, h2, select, button {
                font-family: Helvetica;
            }
            h1 {
                font-size: 200px;
                width:100%;
                margin-top:0px;
            }
            h2 {
                font-size: 40px;
                width:100%;
            }
            .container {
                width: 100%;
                max-width: 600px;
                margin-top:80px;
                margin-right: auto;
                margin-left: auto;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <select id="exerciseSelect">
                <option value="warm_up">Warm-Up</option>
                <option value="cool_down">Cool-Down</option>
                <option value="full_body">Full-Body</option>
                <option value="back_a">Back-A</option>
                <option value="back_b">Back-B</option>
            </select>
            <button onclick="skip(1)">Next</button>
            <br>
            <input type="checkbox" id="homeCheckbox" checked> Home
            <h2 id="exerciseName"></h2>
            <h1 id="exerciseDetails"></h1>
        </div>
    </body>
    <script type="text/javascript">

        var _ex_warm_up = [
            {
                "name": "Sit Foam Roll",
                "seconds": 150,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": true
            },
            {
                "name": "Snow-Angel",
                "seconds": 120,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Scap-Press Lite",
                "seconds": 180,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Cat-Camel",
                "seconds": 150,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
        ];

        var _ex_cool_down = [
            {
                "name": "Chest Stretch",
                "seconds": 30,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Wall Lats Stretch",
                "seconds": 30,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Hamstring Stretch",
                "seconds": 45,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
        ]

        var _ex_full_body = [
            {
                "name": "Abs Twist",
                "seconds": 60,
                "sets": 3,
                "reps": 30,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Squats/Lunges",
                "seconds": 90,
                "sets": 3,
                "reps": 20,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Raise Knee Hip",
                "seconds": 30,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Bicycles",
                "seconds": 30,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            // stretch
            {
                "name": "Lunge Hip Flex",
                "seconds": 30,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "90:90 Hips",
                "seconds": 60,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Calf Stretch",
                "seconds": 30,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            }
        ];

        var _ex_back_a = [
            {
                "name": "Scap Slide", // A-B
                "seconds": 120,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Wall Clocks", // A
                "seconds": 90,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Rows", // A-B
                "seconds": 90,
                "sets": 3,
                "reps": 10,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Bird Dog", // B
                "seconds": 180,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Scap Press Heavy", // A
                "seconds": 120,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "WTYL", // A
                "seconds": 45,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Downward Dog", // A-B
                "seconds": 45,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            }
        ];

        var _ex_back_b = [
            {
                "name": "Scap Slide", // A-B
                "seconds": 120,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Band Wings",
                "seconds": 90,
                "sets": 3,
                "reps": 10,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Scap Plank", // B
                "seconds": 30,
                "sets": 3,
                "reps": 30,
                "extraWait": 0,
                "home": false
            },
            {
                "name": "Band Rotate-A", // B
                "seconds": 90,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": true
            },
            {
                "name": "Band Rotate-B", // B
                "seconds": 90,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": true
            },
            {
                "name": "Band Pull-Down", // B
                "seconds": 90,
                "sets": 3,
                "reps": 10,
                "extraWait": 10,
                "home": true
            },
            {
                "name": "Downward Dog", // A-B
                "seconds": 45,
                "sets": 3,
                "reps": 10,
                "extraWait": 0,
                "home": false
            }
        ];

        var exercises = {
            'warm_up': {
                'steps': _ex_warm_up,
                'warm_up': false,
                'cool_down': true
            },
            'cool_down': {
                'steps': _ex_cool_down,
                'warm_up': false,
                'cool_down': false
            },
            'full_body': {
                'steps': _ex_full_body,
                'warm_up': true,
                'cool_down': true
            },
            'back_a': {
                'steps': _ex_back_a,
                'warm_up': true,
                'cool_down': true
            },
            'back_b': {
                'steps': _ex_back_b,
                'warm_up': true,
                'cool_down': true
            }
        };
        var schedule = [
            'full_body',           // Sunday
            'back_a',        // Monday
            'full_body',           // Tuesday
            'back_b',        // Wednesday
            'full_body',           // Thursday
            'warm_up',        // Friday
            'back_b',           // Saturday
        ];
        var fullExer = [];
        var interval = undefined;

        var restTime = 20;
        var currentSecond = 0;
        var currentStep = 0;
        var totalSecondCounter = 0;
        var totMinutes = 0;

        var isRunning = false;

        var removeHome = function (exerciseArray) {
            var newExer = [];
            exerciseArray.map((ex) => {
                if (!ex.home) {
                    newExer.push(ex);
                }
            });
            return newExer.slice();
        }

        var expandSets = function (exerciseArray) {
            var newExer = [];
            exerciseArray.map((ex) => {
                if (ex.sets && ex.sets > 1) {
                    for (var i=0;i<ex.sets;i++){
                        newExer.push(Object.assign({}, ex));
                    }
                } else {
                    newExer.push(ex);
                }
            });
            return newExer.slice();
        }

        function preloadExercise(name, atHome) {
            /*
            {
                "exercise": [
                    {
                        "name": "name",
                        "seconds": 123,
                        "sets": 3,
                        "reps": 10,
                        "extraWait": 10,
                        "home": false
                    }
                ]
            }
            */
            fullExer = [];
            fullExer = exercises[name]['steps'];
            // prepend with warmp up
            if (exercises[name] && exercises[name]['warm_up']) {
                fullExer = exercises['warm_up']['steps'].concat(fullExer);
            }
            if (exercises[name] && exercises[name]['cool_down']) {
                fullExer = fullExer.concat(exercises['cool_down']['steps']);
            }
            // fullExer = expandSets(fullExer);
            if (atHome == false) {
                fullExer = removeHome(fullExer);
            }
            // calculateTimeRemaining();
            displayInfo();
        }

        function calculateTimeRemaining() {
            var totalSteps = 0;
            totMinutes = fullExer.reduce((tot, val, i) => {
                if (currentStep <= i) {
                    totalSteps += 1;
                    tot += (val.seconds / 60);
                    if (val.extraWait) {
                        tot += (val.extraWait / 60)
                    }
                }
                return tot
            }, 0);
            totMinutes += (restTime * totalSteps) / 60;
            totalSecondCounter = Math.round(totMinutes * 60);
        }

        function getTimeRemainingString() {
            var min = Math.floor(totalSecondCounter / 60);
            min = String(min);
            if (min < 10) min = '0' + min;
            var sec = totalSecondCounter % 60;
            sec = String(sec);
            if (sec < 10) sec = '0' + sec;
            return min + ':' + sec;
        }

        function displayInfo() {
            var exName = fullExer[currentStep].name;
            exName += '<br>' + String(currentStep + 1) + ' / ' + String(fullExer.length);
            // exName += '<br>' + getTimeRemainingString();
            document.getElementById('exerciseName').innerHTML = exName;
            
            // var exDetails = Math.floor(currentSecond);
            // if (exDetails >= 0) {
            //     exDetails = fullExer[currentStep].seconds - exDetails;
            // }
            // exDetails = String(Math.abs(exDetails));
            var exDetails = String(fullExer[currentStep]['sets']);
            exDetails += ' x ';
            exDetails += String(fullExer[currentStep]['reps']);
            document.getElementById('exerciseDetails').innerHTML = exDetails;
        }

        function setColor(color) {
            document.body.style.backgroundColor = color;
        }

        function clearNameTime() {
            document.getElementById('exerciseName').innerHTML = 'Off';
            document.getElementById('exerciseDetails').innerHTML = '...';
        }

        function shiftToNeighborExercise(direction) {
            currentStep += direction;
            if (currentStep < 0) currentStep = 0;
            if (currentStep >= fullExer.length) {
                currentStep = fullExer.length;
                stop();
                return;
            }
            currentSecond = restTime * -1;
            if (fullExer[currentStep].extraWait) {
                currentSecond -= fullExer[currentStep].extraWait
            }
        }

        function workoutStep() {
            totalSecondCounter -= 1;
            currentSecond += 1;
            if (currentSecond >= fullExer[currentStep].seconds) {
                shiftToNeighborExercise(1);
            }
            if (currentSecond < 0) {
                displayInfo();
                setColor('white');
            }
            else if (currentSecond < fullExer[currentStep].seconds){
                displayInfo();
                setColor('rgb(0, 255, 123)');
            }
        }

        function onResumePauseButtonPress() {
            if (isRunning === false) {
                isRunning = true;
                start();
            }
            else {
                isRunning = false;
                pause();
            }
        }

        function pause() {
            if (interval !== undefined) {
                clearInterval(interval);
                interval = undefined;
                setColor('white');
            }
        }

        function start() {
            if (!interval) {
                interval = setInterval(workoutStep, 1000);
                workoutStep();
            }
        }

        function stop() {
            pause();
            clearNameTime();
            currentStep = 0;
            currentSecond = restTime * -1;
            setColor('grey');
        }

        function skip(direction) {
            shiftToNeighborExercise(direction);
            // calculateTimeRemaining();
            displayInfo();
        }

        document.addEventListener('keydown', (event) => {
            if(event.keyCode === 32) { // space
                // onResumePauseButtonPress();
                skip(1);
                event.preventDefault();
            }
            else if(event.keyCode === 39) { // arrow right
                skip(1);
                event.preventDefault();
            } else if(event.keyCode === 37) { // arrow left
                skip(-1);
                event.preventDefault();
            }
        }, false);

        var setFromUi = function(e) {
            atHome = document.getElementById('homeCheckbox').checked;
            exSel = document.getElementById('exerciseSelect').value;
            preloadExercise(exSel, atHome);
        }

        document.getElementById('exerciseSelect').addEventListener('change', setFromUi);
        document.getElementById('homeCheckbox').addEventListener('click', setFromUi);

        window.addEventListener('load', (event) => {
            stop();
            name = schedule[new Date().getDay()];
            document.getElementById('exerciseSelect').value = name;
            preloadExercise(name);
        });

    </script>
</html>
